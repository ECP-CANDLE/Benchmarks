#!/bin/bash
# Begin LSF directives
#BSUB -P med107
#BSUB -J bert_synth
#BSUB -o log.out
#BSUB -W 1:00
#BSUB -nnodes 2 
#BSUB -alloc_flags "nvme smt4"

NODES=$(cat ${LSB_DJOB_HOSTFILE} | sort | uniq | grep -v login | grep -v batch | wc -l)
module load ibm-wml-ce/1.6.2-3
conda activate /ccs/home/iamshang/.conda/envs/shang
export PYTHONPATH=/ccs/home/iamshang/lib/python3.6/site-packages:$PYTHONPATH

# TODO(Todd): rebuild this env: currently broken with a unidentified symbol due to compiler mismatch
#module load gcc/6.4.0
#conda activate /gpfs/alpine/proj-shared/med107/yngtodd/envs/bert2020

WEIGHTS_PATH="gpfs/alpine/proj-shared/med107/g8o/bert_mimic_summit/savedmodels/ncbi_bert_base_pubmed_mimic_uncased"
CMD="python optimize.py --pretrained_weights_path $WEIGHTS_PATH"

jsrun -n$((NODES*6)) -a1 -c7 -g1 -r6 --bind=proportional-packed:7 --launch_distribution=packed $CMD  > running.log

